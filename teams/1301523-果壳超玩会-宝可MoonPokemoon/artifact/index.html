<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Pokemoon - Pokemon Battle Game</title>
    <style type="text/css">
        @font-face {
            font-family: "ThaleahFat";
            src: url("./ThaleahFat.ttf") format("truetype");
            font-weight: normal;
            font-style: normal;
        }
        body { 
            margin: 0; 
            background: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .main-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .game-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            flex: 1;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4ECDC4;
            text-align: center;
            flex-shrink: 0;
        }
        
        canvas {
            display: block; 
            border: 2px solid #4ECDC4;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 300px;
            max-width: 300px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.3);
            height: calc(100vh - 40px);
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .game-button {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex: 1;
            min-width: 120px;
        }
        
        .game-button:hover {
            background: linear-gradient(135deg, #44A08D, #4ECDC4);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .game-button:active {
            transform: translateY(0);
        }
        
        .reset-button {
            background: linear-gradient(135deg, #FF6B6B, #EE5A52);
        }
        
        .reset-button:hover {
            background: linear-gradient(135deg, #EE5A52, #FF6B6B);
        }
        
        .opponent-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .opponent-select label {
            font-weight: bold;
            color: #4ECDC4;
        }
        
        .opponent-select select {
            background: #1a1a1a;
            color: #e2e8f0;
            border: 2px solid #4ECDC4;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .opponent-select select:focus {
            outline: none;
            border-color: #44A08D;
        }
        
        .pokemon-select {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .pokemon-select-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .pokemon-select-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .pokemon-select-item label {
            font-weight: bold;
            color: #4ECDC4;
            font-size: 14px;
        }
        
        .pokemon-select-item select {
            background: #1a1a1a;
            color: #e2e8f0;
            border: 2px solid #4ECDC4;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            width: 100%;
        }
        
        .pokemon-select-item select:focus {
            outline: none;
            border-color: #44A08D;
        }
        
        .player-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .player-select label {
            font-weight: bold;
            color: #4ECDC4;
        }
        
        .player-select select {
            background: #1a1a1a;
            color: #e2e8f0;
            border: 2px solid #4ECDC4;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .player-select select:focus {
            outline: none;
            border-color: #44A08D;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .controls {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-family: ThaleahFat, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            text-align: center;
            margin-top: auto;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            font-size: 12px;
            text-align: center;
            margin-top: auto;
        }
        
        @media (max-width: 1000px) {
            body {
                height: auto;
                overflow: auto;
            }
            
            .main-container {
                flex-direction: column;
                align-items: center;
                height: auto;
                min-height: 100vh;
            }
            
            .control-panel {
                min-width: auto;
                max-width: none;
                width: 100%;
                height: auto;
            }
        }
    </style>
    <script src="pokemoon.js" defer></script>
</head>

<body>
    <div class="main-container">
        <div class="game-section">
            <div class="title">Pokemon Moon v1.0.0</div>
            <canvas id="canvas" height="600" width="800" tabindex="0"></canvas>
        </div>
        
        <div class="control-panel">
            <div class="section-title">游戏控制</div>
            
            <div class="button-group">
                <div class="button-row">
                    <button class="game-button" id="restartBtn" onclick="restartWithEnemy()">重新开始战斗</button>
                    <button class="game-button" id="startBtn" onclick="restartWithSelectedEnemy()">开始对战</button>
                </div>
                <div class="button-row">
                    <button class="game-button" id="changePlayerBtn" onclick="restartWithSelectedPlayer()">更换我方宝可梦</button>
                    <button class="game-button" id="changeBothBtn" onclick="restartWithBoth()">更换双方宝可梦</button>
                </div>
                <div class="button-row">
                    <button class="game-button reset-button" id="resetBtn" onclick="resetBattle()">重置战斗状态</button>
                </div>
            </div>
            
            <div class="pokemon-select">
                <div class="pokemon-select-row">
                    <div class="pokemon-select-item">
                        <label for="playerSelect">我方宝可梦：</label>
                        <select id="playerSelect">
                            <option value="Moonbit月兔">Moonbit月兔</option>
                            <option value="Java咖啡杯">Java咖啡杯</option>
                            <option value="Python蟒蛇">Python蟒蛇</option>
                            <option value="C++齿轮兽">C++齿轮兽</option>
                            <option value="JavaScript电精灵">JavaScript电精灵</option>
                            <option value="C#音符骑士">C#音符骑士</option>
                            <option value="Go地鼠">Go地鼠</option>
                            <option value="Rust螃蟹">Rust螃蟹</option>
                            <option value="Ruby红宝石龙">Ruby红宝石龙</option>
                            <option value="PHP大象">PHP大象</option>
                        </select>
                    </div>
                    
                    <div class="pokemon-select-item">
                        <label for="opponentSelect">对手宝可梦：</label>
                        <select id="opponentSelect">
                            <option value="Java咖啡杯">Java咖啡杯</option>
                            <option value="Python蟒蛇">Python蟒蛇</option>
                            <option value="C++齿轮兽">C++齿轮兽</option>
                            <option value="JavaScript电精灵">JavaScript电精灵</option>
                            <option value="C#音符骑士">C#音符骑士</option>
                            <option value="Go地鼠">Go地鼠</option>
                            <option value="Rust螃蟹">Rust螃蟹</option>
                            <option value="Ruby红宝石龙">Ruby红宝石龙</option>
                            <option value="PHP大象">PHP大象</option>
                            <option value="Moonbit月兔">Moonbit月兔</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <strong>控制说明：</strong><br>
                F1–F5 调试 · WASD/↑↓←→ 移动 · 空格跳跃<br>
                战斗模式：方向键选择 · Enter确认 · Escape取消
            </div>
            
            <div class="status" id="status">
                游戏状态：正在加载...
            </div>
        </div>
    </div>
    
    <script>
        // 全局变量跟踪游戏状态
        let gameStarted = false;
        let isSelectingOpponent = false;
        
        // 添加状态更新
        window.addEventListener('load', function() {
            const status = document.getElementById('status');
            status.textContent = '游戏状态：已加载完成';
            
            // 监听控制台输出
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (args[0] && typeof args[0] === 'string' && args[0].includes('状态')) {
                    status.textContent = '游戏状态：' + args[0];
                }
            };
            
            // 初始化焦点管理
            initializeFocusManagement();
        });
        
        // 初始化焦点管理
        function initializeFocusManagement() {
            const canvas = document.getElementById('canvas');
            const buttons = document.querySelectorAll('.game-button');
            const opponentSelect = document.getElementById('opponentSelect');
            const playerSelect = document.getElementById('playerSelect');
            
            // 为画布添加焦点
            canvas.focus();
            
            // 为所有按钮添加事件监听器
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // 点击按钮后立即将焦点转回画布
                    setTimeout(() => {
                        canvas.focus();
                    }, 100);
                });
                
                // 防止按钮获得焦点
                button.addEventListener('focus', function(e) {
                    e.preventDefault();
                    canvas.focus();
                });
            });
            
            // 为对手选择框添加特殊处理
            opponentSelect.addEventListener('focus', function(e) {
                isSelectingOpponent = true;
                console.log('对手选择框获得焦点');
            });
            
            opponentSelect.addEventListener('blur', function(e) {
                isSelectingOpponent = false;
                console.log('对手选择框失去焦点');
                // 选择框失去焦点后，将焦点转回画布
                setTimeout(() => {
                    canvas.focus();
                }, 100);
            });
            
            opponentSelect.addEventListener('change', function(e) {
                console.log('对手选择框值改变:', e.target.value);
                // 选择框值改变后，延迟将焦点转回画布
                setTimeout(() => {
                    canvas.focus();
                }, 200);
            });
            
            // 为我方宝可梦选择框添加特殊处理
            playerSelect.addEventListener('focus', function(e) {
                isSelectingOpponent = true; // 使用同一个标志位
                console.log('我方宝可梦选择框获得焦点');
            });
            
            playerSelect.addEventListener('blur', function(e) {
                isSelectingOpponent = false;
                console.log('我方宝可梦选择框失去焦点');
                // 选择框失去焦点后，将焦点转回画布
                setTimeout(() => {
                    canvas.focus();
                }, 100);
            });
            
            playerSelect.addEventListener('change', function(e) {
                console.log('我方宝可梦选择框值改变:', e.target.value);
                // 选择框值改变后，延迟将焦点转回画布
                setTimeout(() => {
                    canvas.focus();
                }, 200);
            });
            
            // 监听键盘事件
            document.addEventListener('keydown', function(e) {
                // 如果正在选择宝可梦，不干扰选择框
                if (isSelectingOpponent) {
                    return;
                }
                
                // 如果按的是Enter键且焦点不在画布上
                if (e.key === 'Enter' && document.activeElement !== canvas) {
                    e.preventDefault();
                    e.stopPropagation();
                    // 将焦点转回画布
                    canvas.focus();
                    return false;
                }
            });
            
            // 监听全局点击事件，确保点击后焦点回到画布（除了选择框）
            document.addEventListener('click', function(e) {
                // 如果点击的是选择框或其子元素，不干扰
                if (e.target === opponentSelect || opponentSelect.contains(e.target) ||
                    e.target === playerSelect || playerSelect.contains(e.target)) {
                    return;
                }
                
                // 如果点击的不是画布，延迟将焦点转回画布
                if (e.target !== canvas) {
                    setTimeout(() => {
                        canvas.focus();
                    }, 50);
                }
            });
        }
        
        // 重新开始战斗（使用默认对手）
        function restartWithEnemy() {
            try {
                if (typeof KrystalRay$pokemoon$$restart_game_with_enemy === 'function') {
                    KrystalRay$pokemoon$$restart_game_with_enemy("Java咖啡杯");
                    updateStatus("重新开始战斗 - Java咖啡杯");
                    gameStarted = true;
                    // 确保焦点回到画布
                    setTimeout(() => {
                        document.getElementById('canvas').focus();
                    }, 100);
                } else {
                    console.error("restart_game_with_enemy 函数未找到");
                    updateStatus("错误：函数未找到");
                }
            } catch (error) {
                console.error("重新开始战斗时出错:", error);
                updateStatus("错误：" + error.message);
            }
        }
        
        // 使用选中的对手重新开始战斗
        function restartWithSelectedEnemy() {
            try {
                const selectedOpponent = document.getElementById('opponentSelect').value;
                if (typeof KrystalRay$pokemoon$$restart_game_with_enemy === 'function') {
                    KrystalRay$pokemoon$$restart_game_with_enemy(selectedOpponent);
                    updateStatus("重新开始战斗 - " + selectedOpponent);
                    gameStarted = true;
                    // 确保焦点回到画布
                    setTimeout(() => {
                        document.getElementById('canvas').focus();
                    }, 100);
                } else {
                    console.error("restart_game_with_enemy 函数未找到");
                    updateStatus("错误：函数未找到");
                }
            } catch (error) {
                console.error("重新开始战斗时出错:", error);
                updateStatus("错误：" + error.message);
            }
        }
        
        // 使用选中的我方宝可梦重新开始战斗
        function restartWithSelectedPlayer() {
            try {
                const selectedPlayer = document.getElementById('playerSelect').value;
                if (typeof KrystalRay$pokemoon$$restart_game_with_player === 'function') {
                    KrystalRay$pokemoon$$restart_game_with_player(selectedPlayer);
                    updateStatus("更换我方宝可梦 - " + selectedPlayer);
                    gameStarted = true;
                    // 确保焦点回到画布
                    setTimeout(() => {
                        document.getElementById('canvas').focus();
                    }, 100);
                } else {
                    console.error("restart_game_with_player 函数未找到");
                    updateStatus("错误：函数未找到");
                }
            } catch (error) {
                console.error("更换我方宝可梦时出错:", error);
                updateStatus("错误：" + error.message);
            }
        }
        
        // 使用选中的双方宝可梦重新开始战斗
        function restartWithBoth() {
            try {
                const selectedPlayer = document.getElementById('playerSelect').value;
                const selectedOpponent = document.getElementById('opponentSelect').value;
                if (typeof KrystalRay$pokemoon$$restart_game_with_both === 'function') {
                    KrystalRay$pokemoon$$restart_game_with_both(selectedPlayer, selectedOpponent);
                    updateStatus("更换双方宝可梦 - 我方: " + selectedPlayer + ", 对手: " + selectedOpponent);
                    gameStarted = true;
                    // 确保焦点回到画布
                    setTimeout(() => {
                        document.getElementById('canvas').focus();
                    }, 100);
                } else {
                    console.error("restart_game_with_both 函数未找到");
                    updateStatus("错误：函数未找到");
                }
            } catch (error) {
                console.error("更换双方宝可梦时出错:", error);
                updateStatus("错误：" + error.message);
            }
        }
        
        // 重置战斗状态
        function resetBattle() {
            try {
                if (typeof KrystalRay$pokemoon$$reset_battle_render_state === 'function') {
                    KrystalRay$pokemoon$$reset_battle_render_state();
                    updateStatus("战斗状态已重置");
                    gameStarted = false;
                    // 确保焦点回到画布
                    setTimeout(() => {
                        document.getElementById('canvas').focus();
                    }, 100);
                } else {
                    console.error("reset_battle_render_state 函数未找到");
                    updateStatus("错误：函数未找到");
                }
            } catch (error) {
                console.error("重置战斗状态时出错:", error);
                updateStatus("错误：" + error.message);
            }
        }
        
        // 更新状态显示
        function updateStatus(message) {
            const status = document.getElementById('status');
            status.textContent = '游戏状态：' + message;
        }
        
        // 检查函数是否可用
        function checkFunctions() {
            const functions = [
                'KrystalRay$pokemoon$$restart_game_with_enemy',
                'KrystalRay$pokemoon$$restart_game_with_player',
                'KrystalRay$pokemoon$$restart_game_with_both',
                'KrystalRay$pokemoon$$reset_battle_render_state'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log("✅ " + funcName + " 可用");
                } else {
                    console.warn("❌ " + funcName + " 不可用");
                }
            });
        }
        
        // 页面加载完成后检查函数
        window.addEventListener('load', function() {
            setTimeout(checkFunctions, 1000); // 延迟1秒检查，确保JS文件完全加载
        });
    </script>
</body>

</html>